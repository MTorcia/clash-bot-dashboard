<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Clan Dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #f2f2f2);
            --card-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --text-color: var(--tg-theme-text-color, #000000);
            --accent: var(--tg-theme-button-color, #2481cc);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding-top: 60px; /* Spazio per le tab fisse */ }

        /* TABS FISSE IN ALTO */
        .tabs-container { position: fixed; top: 0; left: 0; right: 0; background: var(--card-bg); z-index: 100; display: flex; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 50px; }
        .tab { flex: 1; padding: 15px; text-align: center; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; color: #888; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* LISTA GIOCATORI */
        .container { padding: 10px; max-width: 600px; margin: 0 auto; margin-top: 10px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 12px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        /* HEADER CARD: Nome e Dati */
        .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .player-name { font-size: 16px; font-weight: bold; }
        .badges { display: flex; gap: 5px; font-size: 13px; font-family: monospace; }
        .badge { padding: 4px 8px; border-radius: 6px; background: rgba(0,0,0,0.05); color: var(--text-color); }
        
        /* CONTROLLI: Select e Input */
        .controls { display: flex; gap: 8px; margin-top: 8px; }
        
        select {
            appearance: none; border: none; font-weight: bold; text-align: center; border-radius: 6px; padding: 8px; cursor: pointer;
        }
        /* Stile specifico per il menu ordinamento */
        #sortSelect { 
            background-color: var(--card-bg); 
            border: 1px solid rgba(0,0,0,0.1); 
            color: var(--text-color);
            font-size: 14px;
        }

        /* Colori Status per la Select */
        .st-0 { background-color: #e0e0e0; color: #555; } /* Bianco */
        .st-1 { background-color: #e6fffa; color: #00a86b; border: 1px solid #00a86b; } /* Verde */
        .st-2 { background-color: #fffaf0; color: #dd6b20; border: 1px solid #dd6b20; } /* Arancione */
        .st-3 { background-color: #fff5f5; color: #e53e3e; border: 1px solid #e53e3e; } /* Rosso */

        input[type="text"] {
            flex: 1; background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; padding: 8px; color: var(--text-color); outline: none; transition: 0.2s;
        }
        input:focus { border-color: var(--accent); background: var(--card-bg); }

    </style>
</head>
<body>

    <div class="tabs-container">
        <div id="tab-curr" class="tab active" onclick="setTab('current')">üî• Attuale</div>
        <div id="tab-hist" class="tab" onclick="setTab('history')">üìú Storico</div>
    </div>

    <!-- BARRA ORDINAMENTO (STICKY SOTTO LE TAB) -->
    <div style="position: sticky; top: 50px; z-index: 90; background:var(--bg-color); padding:10px; text-align:center; border-bottom:1px solid rgba(0,0,0,0.05);">
        <label for="sortSelect" style="font-size:14px; color:#888;">Ordina per:</label>
        <select id="sortSelect" onchange="changeSort(this.value)" style="width:auto; margin-left:5px;">
            <option value="status">üö¶ Status Prioritario</option>
            <option value="decks_asc">üìâ Meno Attacchi</option>
            <option value="decks_desc">üìà Pi√π Attacchi</option>
        </select>
    </div>

    <div class="container" id="list-container">
        <div style="text-align:center; padding:20px; color:#888;">Caricamento dati...</div>
    </div>

    <script>
        // Inizializza Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand(); 

        let globalData = [];
        let currentMode = 'current'; // 'current' o 'history'
        let currentSort = 'status'; // 'status', 'decks_asc', 'decks_desc'

        // Funzione Principale di Caricamento
        async function init() {
            try {
                const response = await fetch('/api/data');
                globalData = await response.json();
                renderList();
            } catch (error) {
                document.getElementById('list-container').innerHTML = `<div style="color:red; text-align:center;">Errore: ${error.message}</div>`;
            }
        }

        // Funzione Helper per ottenere i valori di ordinamento
        function getSortValue(p) {
            if (currentMode === 'current') return p.cur_decks;
            return p.hist_decks; // Usa i mazzi totali dello storico
        }

        // Cambio Ordinamento
        function changeSort(val) {
            currentSort = val;
            renderList();
        }

        // Funzione per disegnare la lista a schermo
        function renderList() {
            const container = document.getElementById('list-container');
            container.innerHTML = '';

            // Recupera la scelta dropdown
            const selectEl = document.getElementById('sortSelect');
            if (selectEl) currentSort = selectEl.value;

            // Crea una copia e ordina
            let list = [...globalData];
            
            list.sort((a, b) => {
                if (currentSort === 'status') {
                    // Ordina per Status (decrescente: nero -> rosso -> verde -> bianco)
                    if (b.status !== a.status) return b.status - a.status;
                    return a.name.localeCompare(b.name);
                } else if (currentSort === 'decks_asc') {
                    // Crescente (chi ha fatto MENO attacchi prima)
                    return getSortValue(a) - getSortValue(b);
                } else if (currentSort === 'decks_desc') {
                    // Decrescente (chi ha fatto PI√ô attacchi prima)
                    return getSortValue(b) - getSortValue(a);
                }
                return 0;
            });

            list.forEach(p => {
                // Prepara i dati in base alla Tab selezionata
                let decksTxt, fameTxt;
                
                if (currentMode === 'current') {
                    // TAB ATTUALE
                    decksTxt = `‚öîÔ∏è ${p.cur_decks}`;
                    fameTxt = `üèÖ ${formatK(p.cur_fame)}`;
                } else {
                    // TAB STORICO
                    decksTxt = `‚öîÔ∏è ${p.hist_decks}/${p.hist_possible}`;
                    fameTxt = `üèÖ ${formatK(p.hist_fame)}`;
                }

                // Crea la Card HTML
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-top">
                        <div class="player-name">${p.name}</div>
                        <div class="badges">
                            <span class="badge">${decksTxt}</span>
                            <span class="badge">${fameTxt}</span>
                        </div>
                    </div>
                    <div class="controls">
                        <select class="st-${p.status}" onchange="updateStatus('${p.tag}', this)">
                            <option value="0" ${p.status==0?'selected':''}>‚ö™</option>
                            <option value="1" ${p.status==1?'selected':''}>üü¢</option>
                            <option value="2" ${p.status==2?'selected':''}>üü†</option>
                            <option value="3" ${p.status==3?'selected':''}>üî¥</option>
                        </select>
                        
                        <input type="text" placeholder="Note..." onchange="updateNote('${p.tag}', this)" onblur="updateNote('${p.tag}', this)" />
                        <span id="status-${p.tag}" style="font-size:12px; margin-left:5px; display:none;">üíæ</span>
                    </div>
                `;
                // Imposta il valore manualmente per evitare problemi con virgolette
                const inputEl = card.querySelector('input');
                inputEl.value = p.note || ''; 
                
                container.appendChild(card);
            });
        }

        // Cambio Tab
        function setTab(mode) {
            currentMode = mode;
            // Aggiorna grafica tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(mode === 'current' ? 'tab-curr' : 'tab-hist').classList.add('active');
            // Ridisegna lista
            renderList();
        }

        // Aggiorna Status (API)
        async function updateStatus(tag, selectEl) {
            const newStatus = parseInt(selectEl.value);
            // Aggiorna colore select subito
            selectEl.className = `st-${newStatus}`;
            
            // Trova e aggiorna dato locale
            const player = globalData.find(p => p.tag === tag);
            if(player) player.status = newStatus;

            // Invia al server
            await sendUpdate(tag, newStatus, player.note);
        }

        // Aggiorna Nota (API)
        async function updateNote(tag, inputEl) {
            const newNote = inputEl.value;
            const player = globalData.find(p => p.tag === tag);
            const statusIcon = document.getElementById(`status-${tag}`);

            if(player) {
                if(player.note === newNote) return; // Non inviare se non √® cambiato nulla
                
                // Feedback Visivo
                if(statusIcon) { statusIcon.style.display = 'inline'; statusIcon.innerText = 'üíæ'; }
                
                player.note = newNote;
                try {
                    await sendUpdate(tag, player.status, newNote);
                    if(statusIcon) { statusIcon.innerText = '‚úÖ'; setTimeout(() => { statusIcon.style.display = 'none'; }, 2000); }
                } catch(e) {
                    if(statusIcon) { statusIcon.innerText = '‚ùå'; console.error(e); }
                }
            }
        }

        // Funzione helper per inviare dati
        async function sendUpdate(tag, status, note) {
            await fetch('/api/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tag, status, note })
            });
        }

        // Formatta numeri (es. 12500 -> 12.5k)
        function formatK(num) {
            if (!num) return '0';
            return num > 999 ? (num/1000).toFixed(1) + 'k' : num;
        }

        // Avvio script
        init();
    </script>
</body>
</html>